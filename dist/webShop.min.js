!function(e,t){"object"==typeof module&&"function"==typeof module.exports?module.exports=t(e):window.WebShop=t(e)}(window||this,function(e){var t,n,o,i,r,a,c,s,l,p,d,u=document.body,f=[],h=new THREE.Raycaster,m=[],x={},y=[],g=[],E=0,w={objUrl:null,infoUrl:null,index:0,gap:200,isFloor:!0,isReset:!0,isBack:!0,lineImg:"../img/jiantou.png",cameraPosition:{x:0,y:100,z:400},selectObjColor:10021119,raycasterIcon:null,floorBoxStyle:"position:fixed;left:10px;bottom:50px;z-index:9;overfloW:hidden;width:30px;background:#34495E;   border-radius:4px;padding:0;margin:0;list-style:none;color:#fff;",floorStyle:"display:block;width:100%;height:30px;text-align:center;line-height:30px;border-color:#ddd;border-width:{{border-width}};border-style:solid;",resetBtnStyle:"position:fixed;right:10px;bottom:100px;background:#34495E;border-radius:50%;width:40px;height:40px;text-align:center;line-height:40px;color:#fff;font-size:10px;",backBtnStyle:"position:fixed;right:10px;bottom:50px;background:#34495E;border-radius:50%;width:40px;height:40px;text-align:center;line-height:40px;color:#fff;font-size:10px;",textStyle:"position:absolute;left:{{x}}px;top:{{y}}px;transform:translate(-50%,-50%);font-size:1.92vw;white-space: nowrap;opacity:{{opacity}};",textSelectStyle:"position:absolute;left:{{x}}px;top:{{y}}px;transform:translate(-50%,-50%);font-size:1.92vw;white-space: nowrap;opacity:1;color:red;"};if(!e.document)throw new Error("此插件必须运行在有document的浏览器环境下");var b=function(e){return new b.prototype.init(e)};return b.prototype={init:function(a){t=this,w=Object.assign({},w,a),(i=new THREE.Scene).updateMatrixWorld(!0),(n=new THREE.PerspectiveCamera(45,e.innerWidth/e.innerHeight,1,2e4)).position.set(w.cameraPosition.x,w.cameraPosition.y,w.cameraPosition.z),(s=new THREE.Group).add(n),i.add(s);var c=new THREE.AmbientLight(11908533);i.add(c);var l=new THREE.PointLight(4473924);return l.position.set(-100,1500,100),s.add(l),(o=new THREE.WebGLRenderer({antialias:!0})).setClearColor(16777215),o.setPixelRatio(e.devicePixelRatio),o.setSize(e.innerWidth,e.innerHeight),o.domElement.id="canvas",u.appendChild(o.domElement),u.style.cssText="margin:0;padding:0;overflow:hidden;position:fixed;width:100vw;height:100vh;",(d=document.createElement("div")).style.cssText="position:absolute;left:0;top:0;height:0;color:#000000;",document.body.appendChild(d),(r=new THREE.OrbitControls(n,o.domElement)).dispose(),r.update(),this.loadObj(),this.bindEvent(),this.animate(),t},loadObj:function(e){e=[];var n=[];if(!w.objUrl)throw new Error("没有传入obj模型");if("string"==typeof w.objUrl)e.push(w.objUrl);else{if("[object Array]"!==Object.prototype.toString.call(w.objUrl))throw new Error("objUrl类型错误，请传入字符串或数组对象");e=w.objUrl}if("string"==typeof w.infoUrl)n.push(w.infoUrl);else{if("[object Array]"!==Object.prototype.toString.call(w.infoUrl))throw new Error("infoUrl类型错误，请传入字符串或数组对象");n=w.infoUrl}var o=new THREE.LoadingManager;o.onProgress=function(e,t,n){console.log(e,t,n)};var i,r=new THREE.TDSLoader(o);Promise.all((i=[],n.forEach(function(e){i.push(new Promise(function(t,n){var o,i,r,a;o=e,i=t,r=n,(a=new XMLHttpRequest).open("GET",o,!0),a.onerror=r,a.timeout=r,a.onload=function(e){i(e.target.response)},a.send(null)}))}),i)).then(function(t){return Promise.all((o=[],n=(n=t).map(function(e){return JSON.parse(e)}),e.forEach(function(e,t){o.push(new Promise(function(o,i){r.load(e,function(e){e.infos=n[t],o(e)},onprogress,function(e){i(e)})}))}),o));var n,o}).then(function(e){t.loadObjhandler(e)}).catch(function(e){throw alert("加载模型失败"),console.log(e),new Error("模型加载失败"+JSON.stringify(e))})},loadObjhandler:function(e){e.forEach(function(e,n){var o=e.infos;e.index=n,e.position.y=n*w.gap,e.traverse(function(n){if(n instanceof THREE.Mesh&&o[n.name]){var i=o[n.name];n.material=new THREE.MeshLambertMaterial,n.material.color.setHex("0x"+i.color),i.name&&(n.myName=i.name,n.geometry.computeBoundingBox(),n.geometry.boundingBox.getSize(),n.peak=t.computePeak(n.geometry.boundingBox,e.position),m.push(n))}}),i.add(e)}),a=e,t.updateText(),w.isFloor&&t.addFloor(),w.isReset&&t.addReset(),w.isBack&&t.addBack(),t.setIndex(w.index),t.emit("done",e)},addFloor:function(){$floor=document.createElement("ul"),$floor.style.cssText=w.floorBoxStyle,a.forEach(function(e,n){var o=document.createElement("li");o.style.cssText=w.floorStyle.replace(/{{border-width}}/,0!==n?"1px":"0"),o.innerText=n+1+"F",o.onclick=function(e){e.stopPropagation(),t.setIndex(n)},$floor.insertBefore(o,$floor.firstChild),y.push(o)}),document.body.appendChild($floor)},addReset:function(){var e=document.createElement("div");e.style.cssText=w.resetBtnStyle,e.innerText="重置",e.onclick=function(e){e.stopPropagation(),t.reset()},document.body.appendChild(e)},addBack:function(){var e=document.createElement("div");e.style.cssText=w.backBtnStyle,e.innerText="返回",e.onclick=function(){history.go(-1)},document.body.appendChild(e)},addLocal:function(e,n){function o(){var t=new THREE.SphereGeometry(e||3,64,64),o=new THREE.MeshLambertMaterial({color:n||16711680}),r=new THREE.Mesh(t,o);return r.position.y=3+c*w.gap,i.add(r),f.push(r),this.mesh=r,this}return o.prototype={getLocal:function(){return{x:this.mesh.position.x,y:this.mesh.position.y}},setLocal:function(e,n,o){o&&t.setIndex(o),this.mesh.position.set(e||0,o?3+o*w.gap:3,n||0)},moveLocal:function(e){e=Object.assign({},{target:null,time:2e3,callback:null},e);var t=createjs.Tween.get(this.mesh.position);if("[object Object]"==Object.prototype.toString.call(e.target))i(e.target.x,e.target.y,e.time);else if("[object Array]"==Object.prototype.toString.call(e.target)){var n;"number"==typeof e.time&&(n=e.time);for(var o=0;o<e.target.length;o++)n||(n=e.time[o]?e.time[o]:e.time[0]),i(e.target[o].x,e.target[o].y,n)}function i(e,n,o){t.to({x:e,z:n},o)}e.callback&&t.call(e.callback)},remove:function(){i.remove(this.mesh),f.splice(f.indexOf(this.mesh),1)}},new o},cleanAllLocal:function(){f.forEach(function(e){i.remove(e)}),f=[]},setLocalIndex:function(){f.position.y=3+c*w.gap},addLine:function(e,t,n,o,r){function a(){var a=this;this.path=[],"[object Array]"===Object.prototype.toString.call(e)?e.forEach(function(e){a.path.push(new THREE.Vector3(e[0],e[2]?e[2]*w.gap+3:3,e[1]))}):"[object Number]"===Object.prototype.toString.call(e)&&a.path.push(new THREE.Vector3(e,n?n*w.gap+3:3,t));var c=new THREE.CatmullRomCurve3(this.path,!1,"catmullrom",.3),s=(new THREE.TextureLoader).load(r||w.lineImg);s.wrapS=s.wrapT=THREE.RepeatWrapping;var l=new THREE.TubeGeometry(c,50,o||1,16,!1),p=new THREE.MeshBasicMaterial({map:s}),d=new THREE.Mesh(l,p);return s.repeat.set(c.cacheArcLengths[c.cacheArcLengths.length-1]/8,3),i.add(d),g.push(d),this.mesh=d,this}return a.prototype={addPoint:function(e,t,n){var o=this;"[object Array]"===Object.prototype.toString.call(e)?e.forEach(function(e){o.path.push(new THREE.Vector3(e[0],e[2]?e[2]*w.gap+3:3,e[1]))}):"[object Number]"===Object.prototype.toString.call(e)&&o.path.push(new THREE.Vector3(e,n?n*w.gap+3:3,t)),o.updateLine()},updateLine:function(){var e=new THREE.CatmullRomCurve3(this.path,!1,"catmullrom",.3);this.mesh.geometry=new THREE.TubeGeometry(e,50,1,16,!1),this.mesh.material.map.repeat.set(e.cacheArcLengths[e.cacheArcLengths.length-1]/8,3)},remove:function(){i.remove(this.mesh),g.splice(g.indexOf(this.mesh),1)}},new a},updateLineTexture:function(){!g||g.length<=0||g.forEach(function(e){e.material.map.offset.setX(.1*-E),e.material.map.needsUpdate=!0,e.material.needsUpdate=!0})},cleanAllLine:function(){g.forEach(function(e){i.remove(e)}),g=[]},raycastFn:function(){if(l){h.setFromCamera(l,n);var e=h.intersectObjects(m);e.length>0?p!=e[0].object?(p&&p.material.color.setHex(p.currentHex),(p=e[0].object).currentHex=p.material.color.getHex(),p.material.color.setHex(w.selectObjColor),t.emit("select",p),t.setIndex(p.parent.index,t.updateText)):t.updateText():(p&&p.material.color.setHex(p.currentHex),p=null,t.updateText())}},onselect:function(e){t.on("select",e)},getSelect:function(){return p},focusAt:function(e){t.hideText(),createjs.Tween.get(s.position).to({x:a[c].position.x,y:a[c].position.y,z:a[c].position.z},600,createjs.Ease.sineInOut).call(function(){e&&e(),t.updateText(),t.showText()})},setIndex:function(e,n){void 0!==e&&e!==c?(c=e,y.forEach(function(t,n){t.style.background=n===e?"#DC0000":"none"}),t.focusAt(n)):t.updateText()},addAxes:function(){var e=new THREE.AxesHelper(2e3);i.add(e);var t=new THREE.CameraHelper(n);i.add(t)},animate:function(){requestAnimationFrame(function(){t.animate()}),E>=1e4&&(E=0),E++,r.update(),t.render(),t.updateLineTexture()},render:function(){n.updateMatrixWorld(),o.render(i,n)},updateText:function(){if(!(m.length<=0)){n.position;m.forEach(function(e){if(!1!==e.dom)if(e.parent.index==c)if(e.dom){if(0==(n=t.toScreen(e.peak)).isInScreen)return e.dom.style.display="none";e.dom.style.cssText=p===e?w.textSelectStyle.replace(/{{x}}/g,n.x).replace(/{{y}}/g,n.y):w.textStyle.replace(/{{x}}/g,n.x).replace(/{{y}}/g,n.y).replace(/{{opacity}}/g,n.opacity)}else{var n=t.toScreen(e.peak),o=document.createElement("div");o.innerText=e.myName,0==n.isInScreen?o.style.display="none":o.style.cssText=w.textStyle.replace(/{{x}}/g,n.x).replace(/{{y}}/g,n.y).replace(/{{opacity}}/g,n.opacity),d.appendChild(o),e.dom=o}else e.dom&&(e.dom.style.display="none")}),t.updateRaycasterIcon()}},updateRaycasterIcon:function(){if(w.raycasterIcon&&p){var e=t.toScreen(p.peak);w.raycasterIcon.style.position="fixed",w.raycasterIcon.style.left=e.x+"px",w.raycasterIcon.style.top=e.y+"px",w.raycasterIcon.style.display="block"}else w.raycasterIcon.style.display="none"},showText:function(){d.style.display="block"},hideText:function(){d.style.display="none",w.raycasterIcon&&(w.raycasterIcon.style.display="none")},bindEvent:function(){var e,i,a,c=new Hammer(o.domElement);c.get("pinch").set({enable:!0}),c.get("rotate").set({enable:!0}),canvas.addEventListener("click",function(e){(l=new THREE.Vector2).x=e.pageX/window.innerWidth*2-1,l.y=-e.pageY/window.innerHeight*2+1,t.raycastFn()}),c.on("panstart",function(n){e=!0,t.hideText(),r.panStart(n)}),c.on("panmove",function(t){e&&r.panMove(t)}),c.on("panend",function(n){e&&(r.panEnd(n),t.updateText(),t.showText(),e=!1)}),c.on("rotatestart",function(e){i=!0,t.hideText(),r.rotateStart(e)}),c.on("rotatemove",function(e){i&&r.rotateMove(e)}),c.on("rotateend",function(e){i&&(r.rotateEnd(e),t.updateText(),t.showText(),i=!0)}),c.on("pinchstart",function(e){a=!0,t.hideText(),r.scaleStart(e)}),c.on("pinchmove",function(e){a&&r.scaleMove(e)}),c.on("pinchend",function(e){a&&(t.updateText(),t.showText(),a=!1)}),window.addEventListener("resize",function(){n.aspect=window.innerWidth/window.innerHeight,n.updateProjectionMatrix(),o.setSize(window.innerWidth,window.innerHeight),t.updateText()})},done:function(e){return this.on("done",e),t},reset:function(){r.reset(),r.update(),p=null,t.updateText(),t.cleanAllLine()},emit:function(e,n){e&&x[e]&&x[e].length>0&&x[e].forEach(function(e){e&&e.call(t,n)})},on:function(e,t){x[e]||(x[e]=[]),x[e].push(t)},toScreen:function(e){var t=new THREE.Vector3(e.x,e.y,e.z),o=new THREE.Vector3;(o=o.setFromMatrixPosition(n.matrix)).x+=s.position.x,o.y+=s.position.y,o.z+=s.position.z;var i=Math.round(t.distanceToSquared(o)),r=1;r=i>1e6?0:i<1e5?1:(1e6-i)/1e6;var a=t.project(n),c=window.innerWidth/2,l=window.innerHeight/2;return{x:Math.round(a.x*c+c),y:Math.round(-a.y*l+l),z:i,opacity:r,isInScreen:a.x>=-1&&a.x<=1&&a.y<=.4&&a.z>=-1&&a.z<=1}},computePeak:function(e,t){var n={min:{x:e.min.x+t.x,y:e.min.y+t.y,z:e.min.z+t.z},max:{x:e.max.x+t.x,y:e.max.y+t.y,z:e.max.z+t.z}};return{x:(e.max.x+e.min.x)/2,y:n.max.y,z:(e.max.z+e.min.z)/2}},clone:function(e){if(void 0===e||null===e)return null;if("string"==typeof e||"number"==typeof e||"boolean"==typeof e)return e;var t={};for(var n in e)t[n]=e[n];return t}},b.prototype.init.prototype=b.prototype,b});